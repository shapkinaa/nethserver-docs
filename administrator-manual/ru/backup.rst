======
Резервное копирование
======

:index:`Резервное копирование` - один из возможных вариантов восстановления данных компьютера после катастрофы.
Система предлагает два вида резервного копирования:

* :index:`конфигурации сервера`
* :index:`данных сервера`

Резервное копирование конфигурации сервера включает конфигурационные файлы Системы. 
Оно запускается каждую ночь, архив (:file:`/var/lib/nethserver/backup/backup-config.tar.xz`) будет создан только в случае если за последние 24 часа был изменен какой-либо файл.
В процессе резервного копирования конфигурации сервера также сохраняется список установленных модулей. Все модули могут быть переустановлены в процессе восстановления конфигурации из резервной копии.
Целью этого типа резервного копирования является быстрое восстановление системы после сбоя. Функциональность сервисов может быть восстановлена при работающем сервере.

Для резервного копирование данных требуется установленный и разрешенный к использованию модуль "backup", в котором должен быть настроено копирование всех пользовательских данных, таких как домашние директории и электронная почта. Резервное копирование данных запускается каждую ночь и может быть полным или инкриментальным, на основе еженедельных полных копий.
В архив с еженедельной резервной копией включается резервная копия конфигурации сервера.

Резервное копирование данных может быть сохранено на три разных носителя:

* USB: диск подключенный к локальному USB порту (подробнее см.: :ref:`backup_usb_disk-section`)
* CIFS: общая папка Windows, которая доступна на любом NAS (Network Attached Storage)
* NFS: общая папка Linux, которая доступна на любом NAS, как правило это быстрее чем CIFS

Результат процедуры резервного копирования может быть отправлен на электронную почту системному администратору, либо на любой другой внешний адрес.

.. note:: Определение целевой директории для резервного копирования происходит на основе имени сервера, на котором она располагается. К примеру, при смене FQDN сервера, администратор должен аккуратно перенести резервные копии на новый сервер.

Восстановление данных
============

Удостовериться, что дректория назначения доступна для записи (к примеру, USB диск должен быть подключен).

Командная строка
------------

Вывод списка файлов
^^^^^^^^^^^^^

Для вывода списка всех файлов, находщихся в последней резервной копии необходимо ввеста следующую команду: ::

 backup-data-list

В зависимости от размера резервной копии, выполнение команды займет какое-то время.

Файлы и директории
^^^^^^^^^^^^^^^^^^

Файлы, находящиеся в директории :file:`/var/lib/nethserver/`, размещаются в соответствующих поддиректориях:

* Почта: :file:`/var/lib/nethserver/vmail/<user>`
* Общие папки: :file:`/var/lib/nethserver/ibay/<name>`
* Домашние директории: :file:`/var/lib/nethserver/home/<user>`

Для восставновления файла/директории используется команда: ::

  restore-file <position> <file>

Например, восстановление почты учетной записи *test* в директорию :file:`/tmp`: ::

  restore-file /tmp /var/lib/nethserver/vmail/test

Например, восстановление почты учетной записи *test* в оригинальную директорию: ::

  restore-file / /var/lib/nethserver/vmail/test


Система позволяет восстановить предыдущую версию директории (или файла).

Например, восстановление 15-ти дневной версии файла: ::

  restore-file -t 15D /tmp "/var/lib/nethserver/ibay/test/myfile" 

Флаг ``-t`` позволяет указать количество дней (15 в этом примере).

Графический интерфейс
-----------------

В секции меню :menuselection:`Восстановление данных` возможен поиск, выбор и восстановление
одной или нескольких директорий. Навигация осуществляется с помощью графического дерева каталогов, содержащихся в резервной копии.

Два возможных пути восстановления:

* Восстановление данных происходит в оригинальное место, текущие файлы в файловой системе будут переписаны восстанавливаемыми из резервной копии.
* Восстановление данных происходит в оригинальное место, но восстанавливаемые файлы будут помещены в новую директорию (файлы переписаны не будут) этого пути: ::

  /complete/path/of/file_YYYY-MM-DD (YYYY-MM-DD, где дата восстановления данных)

Для поиска следует ввести не менее 3 символов в поле поиска и подпадающие под условие директории будут подсвечены автоматически.

Восставноление выбранных данных осуществляется с помощью кнопки **Restore**.

.. note:: Множественный выбор восстанавливаемых данных можно сделать с помощью клавиши Ctrl.


Восстановление после сбоя
=================

Восстановление системы осуществляется в два этапа: первый - восстановление конфигурации, второй - данных. 
Сразу после восстановления конфигурации система готова к использованию, если установлены все необходимые пакеты. 
Вы можете установить дополнительные пакеты до восстановления или после.
К примеру, если почтовый сервер установлен, то система может отправлять и получать письма.

Другие восстанавливаемые данные конфигурации:

* пользователи и группы
* SSL сертификаты

.. note:: Пароль пользователя root/admin не восстанавливается.

Шаги для выполнения восстановления:

1. Установите новый сервер с тем же именем, что и старый
2. Настройте резервное копирование, чтобы система могла видеть сохраненные резервные копии
3. Если старый сервер выступал в роли сетевого шлюза, то не забудьте установить модуль межсетевого экрана
4. Восстановите резервную копию конфигурации с помощью страницы :guilabel:`Резервное копирование
   (конфигурация) > Восстановление` в веб интерфейсе Server Manager, или запустите команду из консоли:
   :command:`restore-config`
5. Перенастройте сетевые роли, если этого требует предупреждающее сообщение. См. ниже :ref:`restore-roles-section`.
6. Проверьте функционал системы
7. Восстановите данные, запустив команду: :command:`restore-data`


.. _restore-roles-section:
   
Восстановление сетевых ролей
---------------------

В случае если в конфигурации описан отсутствующий сетевой интерфейс, на страницах
:guilabel:`Dashboard`, :guilabel:`Резервное копирование (конфигурация) > Восстановление`
и :guilabel:`Сеть` будут показаны предупреждающие сообщения. Это происходит в следующих случаях:

* резервная копия конфигурации восстановлена на новое аппаратное обеспечение
* одна или несколько сетевых карт заменены
* системный диск установлен на новый сервер

Сообщение указывает на страницу, на которой подсвечены сетевые карты с не назначенной ролью (:ref:`role
<network-section>`). Для таких карты можно выбрать восстанавливаемую роль с помощью выпадающего списка.

Например, если была заменена карта с ролью *оранжевый*, то в выпадающем списке, для новой карты, будет предложен ``оранжевый`` элемент.

То же самое относится и к картам, являющихся частью логического интерфейса, таких как мост и связь.

После выбора элемента выпадающего списка, старая роль новому физическому интерфейсу.

Для применения изменных значений необходимо нажать на кнопку :guilabel:`Submit`.

.. warning:: Будьте осторожны при изменении настроек интерфейсов.
             Одна ошибка может привести к сетевой связи с системой!

Если недостающая роль "зеленая", интерактивная процедура запрашивает исправление конфигурации во время загрузки,
чтобы обеспечить минимальное сетевое подключение и снова войти в Server Manager.


.. _backup_config_rpms:

Восстановление установленных модулей
-------------------------

По умолчанию процесс восстановления конфигурации произведет восстановление всех ранее установленных модулей.

Для избежания повторной установки модулей следует выполнить команду: ::

  config setprop backup-config reinstall disabled
     
.. _backup_customization-section:

Настройка резервной копии данных
=========================

Если установлено дополнительное программное обеспечения, администратор может редактировать список резервируемых файлов или директорий, как включать в список, так и выключать их от туда.

Включение файлов в список
---------

Если вы хотите включить файл или директорию в список данных резервного копирования, то необходимо добавить путь к файлу или директории в файл :file:`/etc/backup-data.d/custom.include`.

Например, для резервного копирования программного обеспечения установленного в директорию :file:`/opt`, достаточно добавить следующую строку: ::

  /opt/mysoftware

Исключение файлов из списка
---------

Если вы хотите исключить файл или директорию из резервного копирования, добавьте строку в файл :file:`/etc/backup-data.d/custom.exclude`.

Например, для исключения всех директорий с именем *Download* следует добавить: ::

  **Download**

Для исключения директории с именем *test*: ::

  /var/lib/nethserver/vmail/test/ 


Те же самые правила используются для настройки резервного копирования конфигураций. Все изменения должны вносится в файл :file:`/etc/backup-config.d/custom.exclude`.


.. note:: Не оставляйте пустых строк в файлах


Настройка резервной копии конфигурации
==================================

В большинстве случаев нет необходимости изменять состав резервной копии конфигурации системы. 
Но это возможно, например, вы установили собственные SSL сертификаты. 
В этом случае вы можете добавить файл с сертификатом в список файлов помещаемых в резервную копию.

Включение файлов в список
---------

Если вы хотите включить файл или директорию в список данных резервного копирования, то необходимо добавить путь к файлу или директории в файл :file:`/etc/backup-config.d/custom.include`.

К примеру, для резервирования файла :file:`/etc/pki/mycert.pem` следует добавить путь: ::

  /etc/pki/mycert.pem

Не добавляйте фольшие директории или файлы в резервную копию конфигурации.

Исключение файлов из списка
---------

Если вы хотите исключить файл или директорию из резервного копирования, добавьте строку в файл :file:`/etc/backup-config.d/custom.exclude`.

.. note:: 
   Не оставляйте пустых строк в файлах.
   Конфигурационные файлы могут состоять только из строк с именами файлов и директорий.

.. _backup_usb_disk-section:

Настройка USB диска
======================

Наилучшим вариантом файловой системы для USB диска резервного копирования является EXT3.
Файловая система FAT поддерживается, но *не рекомендуется* к использованию,
NTFS пока **не поддерживается**.

Перед форматированием диска следует подключить его к серверу и произвести поиск имени устройства: ::

 # dmesg | tail -20

 Apr 15 16:20:43 mynethserver kernel: usb-storage: device found at 4
 Apr 15 16:20:43 mynethserver kernel: usb-storage: waiting for device to settle before scanning
 Apr 15 16:20:48 mynethserver kernel:   Vendor: WDC WD32  Model: 00BEVT-00ZCT0     Rev:
 Apr 15 16:20:48 mynethserver kernel:   Type:   Direct-Access           ANSI SCSI revision: 02
 Apr 15 16:20:49 mynethserver kernel: SCSI device sdc: 625142448 512-byte hdwr sectors (320073 MB)
 Apr 15 16:20:49 mynethserver kernel: sdc: Write Protect is off
 Apr 15 16:20:49 mynethserver kernel: sdc: Mode Sense: 34 00 00 00
 Apr 15 16:20:49 mynethserver kernel: sdc: assuming drive cache: write through
 Apr 15 16:20:49 mynethserver kernel: SCSI device sdc: 625142448 512-byte hdwr sectors (320073 MB)
 Apr 15 16:20:49 mynethserver kernel: sdc: Write Protect is off
 Apr 15 16:20:49 mynethserver kernel: sdc: Mode Sense: 34 00 00 00
 Apr 15 16:20:49 mynethserver kernel: sdc: assuming drive cache: write through
 Apr 15 16:20:49 mynethserver kernel:  sdc: sdc1
 Apr 15 16:20:49 mynethserver kernel: sd 7:0:0:0: Attached scsi disk sdc
 Apr 15 16:20:49 mynethserver kernel: sd 7:0:0:0: Attached scsi generic sg3 type 0
 Apr 15 16:20:49 mynethserver kernel: usb-storage: device scan complete
 
Другой хорошей командой для этого является: ::

 lsblk -io KNAME,TYPE,SIZE,MODEL

В этом примере, подключенный диск получил имя устройства *sdc*.

* Создание Linux раздела на всем диске: ::

    echo "0," | sfdisk /dev/sdc

* Создание файловой системы на разделе *sdc1* с меткой *backup*: ::

    mke2fs -v -T largefile4 -j /dev/sdc1 -L backup

* Переподключение USB диска:

  Вы можете это произвести не только физически, но и с помощью команды: ::

    blockdev --rereadpt /dev/sdc

* После этого метка *backup* должна появится на странице :guilabel:`Резервное копирование (данные)`.

